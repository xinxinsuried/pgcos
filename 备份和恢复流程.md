# 备份和恢复流程

## 备份流程（全量逻辑备份）
1. 进入面板：`docker compose run --rm panel`。
2. 选择 configure：填写 `instance_id`、PG 容器、超级用户、COS 配置等。
3. 选择 test-connection：校验 PG 容器与 COS 访问。
4. 选择 backup-now：触发一次全量备份。
5. 备份产物会上传到：
   - `s3://{bucket}/{prefix}/{instance_id}/{YYYY-MM-DD_HH-MM-SS}/globals.sql.zst`
   - `s3://{bucket}/{prefix}/{instance_id}/{YYYY-MM-DD_HH-MM-SS}/{dbname}.dump.zst`
   - 对应 `.sha256` 校验文件

## 自动定时备份流程
1. `docker compose up -d` 启动 scheduler 服务。
2. scheduler 读取 `./config/config.env` 中的 `SCHEDULE_CRON`（默认每天 03:00）。
3. 如修改配置，请执行 `docker compose restart scheduler` 使其生效。

## 恢复流程（跨服务器/新容器）
1. 启动一个空的 PostgreSQL 容器（版本必须 >= 源版本）。
2. 在新服务器运行：`docker compose up -d`。
3. 进入面板：`docker compose run --rm panel`。
4. 选择 configure：指向新 PG 容器与同一 COS；填写同一个或要恢复的 `instance_id`。
5. 选择 restore latest 或 restore select：
   - restore latest：恢复该实例的最近一次备份
   - restore select：列出该实例最近 20 个备份供选择
6. 恢复完成后，可使用原有 dbname/user/password 直接连接。

## 重要提示
- 不修改 PostgreSQL 配置；仅使用 `docker exec` 调用 `pg_dump/pg_dumpall/psql/pg_restore`。
- 目标 PostgreSQL 版本必须 >= 源版本。
- 如使用扩展（extension），目标容器需具备对应扩展，否则恢复可能失败。
- `instance_id` 用于多实例区分；列表/恢复/清理会先选择实例。
